---
title: "Analyzing trends of organ donor enrollment in New York state"
output: 
  github_document:
    md_extensions: +tex_math_dollars
                   +raw_html
always_allow_html: yes
---

```{r setup and data import, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, dpi = 300, out.width = "65%")

library(tidyverse)
library(lme4)
library(modelr)
library(kableExtra)
library(ggplot2)
library(rvest)
library(httr)
library(ggrepel)

theme_set(theme_bw())
```

|Name            | Uni       |
|----------------|-----------|
|Shuliang Deng   | sd3258    |
|Nick Williams   | ntw2117   |
|Sijia Yue       | sy2824    |
|Jack Yan        | xy2395    |
|Alina Levine    | al3851    |

[Click here for cleaned data used for analyses](https://www.dropbox.com/sh/grlugs9hrksvkqr/AAAwILSg5UyMrW1CD7dWmHPNa?dl=0)

 Organ donation is a public health crisis in New York where there are currently 9,449 people waiting for an organ transplant. Due to the scarcity of donated organs, many people do not survive long enough receive a donated organ, and those that do may have wait years for an organ. At Columbia University Medical center, over 2016 and 2017, the mortality rate for the kidney donation waitlist was 7.2 percent.
  Like every state, NY has a first person consent policy for deceased organ donation. If a person on the donor registry list dies and is a candidate for organ donation, his or her family cannot prevent an organ procurement agency from gifting the organs to a person on an organ waitlist. Although uniform enforcement of this law is questionable, first person consent is believed to be important in supplying organ donations.
  New York, however, has the lowest proportion of eligible people enrolled on the donor registry. We were interested in exploring how NY donor designation share (percent of eligible people enrolled) has changed over the last decade and were interested in comparing country donation rates, to see if a targeted approach to increasing NY's organ donation rate may be warranted.  

## Initial questions

### Trends and Policies

Over the last 6 years, the state government has passed into law several policies to increase the donor designation share. In 2012 it passed Lauren's law, which requires the DMV drivers license application to force people to decide whether or not they will join the registry. In order to complete the application, applicants must actively mark that they will skip over the question. In 2017 the govenor of NY passed a law that reuiquires health insurance applications to asks people if they want to sign up for the organ registry. 

Additionally, in 2016, the size of the eligible pool increased when the minimum age for joining the registry was lowered from eighteen to sixteen.

Was there a statewide change in the growth of donor designation share after any of these laws were passed? If there was, was this change seen in all counties or only a subset?

### County Characteristics

What are some factors that predict county donor designation share?

## Data 

New York State organ donor data was pulled from New York's official public data [API](https://health.data.ny.gov/Health/Donate-Life-Organ-and-Tissue-Donor-Registry-Enroll/sqk8-8a2h/data?fbclid=IwAR0DjHPMd3up76Cq1bMH0z12f_vr4rLz5YwtMPcT2kc_a5nP-nVJlDEinNE). 

```{r ny api data, message = FALSE}
organ <- GET("https://health.data.ny.gov/resource/km5a-7zrs.csv?$limit=10000") %>% 
  content("parsed") %>%
  janitor::clean_names() %>%
  filter(county != "Out of State" & county != "Unknown") %>%
  mutate(year = as.character(year)) %>%
  mutate(month = as.character(month)) %>%
  mutate(dummy_day = as.character("01")) %>%
  mutate(date = (str_c(year, month, dummy_day, sep = "-"))) %>%
  mutate(date = as.Date(date, "%Y-%m-%d")) %>% 
  rename(pop_2012 = "x2012_census_population")
```

Splines were created in correspondence with three major policy changes designed to increase donor registration. In order to include time as a variable dates were converted to the number of days since the first data point in the database (September 1, 2008). Counties Cattauragus and St. Lawrence were removed for analysis due to what we believe to be incorrect data entry (i.e. the proportion over the entire timeframe did not change at all for either of these counties). 

```{r spline info}
organ_sp <- organ %>% 
  mutate(year_sp_2012 = (date > "2012-10-1") * (date - as.Date("2012-10-1")), 
         year_sp_2016 = (date > "2016-5-1") * (date - as.Date("2016-5-1")), 
         year_sp_2017 = (date > "2017-2-14") * (date - as.Date("2017-2-14")),
         total_days = date - as.Date("2008-09-01")) %>% 
  filter(!(county %in% c("TOTAL NYS", "Cattauragus", "St Lawrence"))) %>% 
  mutate(opo = as_factor(opo), 
         opo = fct_relevel(opo, 
                           "New York Organ Donor Network", 
                           "Center for Donation and Transplant in New York", 
                           "UNYTS", 
                           "Finger Lakes Donor Recovery Network"))
```

Extra county level data came from Area Health Resources Files (AHRF). AHRF data collects healthcare related information and demographics at the county level for every county in the United States. Specific variables were chosen from AHRF to be included in this analysis. AHRF data is provided as a SAS datafile with un-informative variable names for over 3000 variables; as such, extracting specific variables presented a challenge. Variables labels in SAS are recorded as a variable attribute in R. The following code was used to extract the specific variables used in our analyses. 

```{r eval = FALSE}
library(haven)

ahrf <- 
  read_sas("data/ahrf.sas7bdat")

ahrf_selected <- read_csv("data/ahrf_selected_variables.csv")
  
check_label <- function(x) {
  if (attr(ahrf[[x]], "label") %in% ahrf_selected$label) {
    return(x)
  }
}

# check_label("f1529815")

keep_var <- list()

for (i in names(ahrf)) {
 keep_var[i] <- check_label(i)
}

keep_var <- names(keep_var)

ahrf <- ahrf %>% 
  select(keep_var)

keep_names <- list()

for (i in 1:ncol(ahrf)) {
  keep_names[[i]] <- attr(ahrf[[i]], "label")
}

for (i in 1:length(keep_names)) {
  names(keep_names)[i] <- "label"
}

keep_names <- data.frame(keep_names) %>% 
  gather(keep, label, label:label.17) %>% 
  select(label)

data.table::setnames(ahrf, old = keep_var, new = keep_names$label)

ahrf <- ahrf %>% 
  janitor::clean_names() %>% 
  filter(state_name == "New York")

ahrf %>% 
  write_csv("data/ahrf_select_data.csv")
```

## Exploratory analyses

```{r population vs. percent, results = "hide", message = FALSE, warning = FALSE}
lowest_3_counties = organ %>% 
  filter(date == as.Date("2018-09-01")) %>% 
  filter(county != "TOTAL NYS") %>%
  arrange(eligible_population_enrolled) %>%
  top_n(n = -3, eligible_population_enrolled)

top_county = organ %>% 
  filter(date == as.Date("2018-09-01")) %>% 
  filter(county != "TOTAL NYS") %>%
  arrange(eligible_population_enrolled) %>%
  top_n(n = 1, eligible_population_enrolled)

organ %>% 
  filter(date == as.Date("2018-09-01")) %>% 
  filter(county != "TOTAL NYS") %>%
  ggplot(aes(x = population_18_estimate, y = eligible_population_enrolled)) +
    geom_point() +
    labs(title = "Eligible Population vs Percent Enrolled by County",
         x = "Estimated Population 18 and Over",
         y = "Percent of Eligible Population Enrolled") +
    geom_text_repel(data = lowest_3_counties, 
                    aes(x = population_18_estimate, 
                        y = eligible_population_enrolled, 
                        label = county)) +
    geom_text_repel(data = top_county, 
                    aes(x = population_18_estimate, 
                        y = eligible_population_enrolled, 
                        label = county))
```

This plot shows that there is a negative correlation between the number of eligible potential donors and the percentage of eligible people enrolled. Three large counties in NYC, Bronx, Queens, and Kings have the lowest percentage. Smaller counties have percentages that allign with those of neighboring states, such as New Jersey and Connecticut. 

## Formal analyses

Formal analyses of the effect of major policy changes were conducted using mixed-effects linear models with a random intercept; counties were treated as the clustering variable. The outcome was analyzed was the proportion of eligible adults registered with one of four organ donor organizations. Four successive models were created: a model only analyzing a linear effect of time; a model including a term for a spline corresponding with a 2012 policy INSERT WHAT THIS POLICY WAS; a model including a term for a spline corresponding with a 2016 policy INSERT WHAT THIS POLICY WAS; a model including a term for a spline corresponding with a 2017 policy that lowered the age from eligible enrollees from 18 to 16 years old; and a model that included all splines. All models were adjusted for the specific organization used in each county; models were compared using likelihood ratio tests. 

```{r no model, message = FALSE}
organ_sp %>% 
  ggplot() +
  geom_line(aes(x = total_days, y = eligible_population_enrolled, color = opo, group = county), 
            alpha = 0.6) +
  viridis::scale_color_viridis(discrete = TRUE) + 
  labs(title = "Proportion of eligible New Yorkers enrolled as organ donors",
       subtitle = "Dashed lines indicate 3 policies to be anlayzed",
       x = "Time as total days",
       y = "Eligible population enrolled (%)") +
  geom_vline(xintercept = 1491, linetype = "dashed") + 
  geom_vline(xintercept = 2799, linetype = "dashed") + 
  geom_vline(xintercept = 3088, linetype = "dashed") +
  annotate(geom = "text", x = 1720, y = 53, label = "2012") +
  annotate(geom = "text", x = 2600, y = 5, label = "2016") +
  annotate(geom = "text", x = 3300, y = 5, label = "2017") +
  theme(legend.position = "bottom", 
        legend.title = element_blank()) + 
  guides(color = guide_legend(ncol = 2))
```

The above plot shows the increasing trend of organ donor enrollment over time. The dashed lines represent the beginning of the 3 policies we analyzed in this project. 

The first model built only analyzed the effect of the 2012 policy. Main effects of time and the 2012 spline were found. Overall, every one year change resulted in a 2.88 percentage point increase in registry enrollment (95% CI: 2.84, 2.93) up to the beginning of the 2012 policy. However, after the 2012 policy went into effect the rate of increase in enrollment dropped 2.56 percentage points. 

```{r spline 2012, message = FALSE}
sp_12_model <- organ_sp %>% 
  lmer(eligible_population_enrolled ~ total_days + year_sp_2012 + (1 | county), data = .)

sp_12_model %>% 
  broom::tidy() %>% 
  filter(term %in% c("total_days", "year_sp_2012")) %>% 
  mutate(estimate_year = estimate * 365, 
         se_year = std.error * 365, 
         ci_low = estimate_year - 1.96*se_year, 
         ci_upper = estimate_year + 1.96*se_year) %>% 
  mutate(term = ifelse(term == "total_days", "Time (year)", term), 
         term = ifelse(term == "year_sp_2012", "2012 spline", term)) %>% 
  select(term, estimate_year, se_year, ci_low, ci_upper) %>% 
  rename("Term" = term, 
         "Coefficient" = estimate_year, 
         "SE" = se_year, 
         "Lower bound" = ci_low, 
         "Upper bound" = ci_upper) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling(full_width = F, bootstrap_options = c("hover", "striped"))

add_predictions(organ_sp, sp_12_model) %>% 
  ggplot(aes(x = total_days, y = pred, color = opo, type = county)) + 
  geom_line() +
  geom_vline(xintercept = 1491, linetype = "dashed") +
  annotate(geom = "text", x = 1720, y = 5, label = "2012") +
  viridis::scale_color_viridis(discrete = TRUE) + 
  labs(title = "Proportion of eligible New Yorkers enrolled as organ donors", 
       subtitle = "Modeling 2012 spline", 
       x = "Time as total days", 
       y = "Eligible population enrolled (%)") + 
  theme(legend.position = "bottom", 
        legend.title = element_blank()) + 
  guides(color = guide_legend(ncol = 2))
```

Modeling the effect of the 2016 policy, we once again found main effects of time and the 2016 spline. On average, every year increase resulted in an estimated 2.56 percentage point increase in eligible adult enrollment until the 2016 policy went into effect. After the 2016 policy, the estimated rate at which enrollment was changing increased by 0.79 percentage points (95% CI: 0.69, 0.89). 
 
```{r spline 2016, message = FALSE}
sp_16_model <- organ_sp %>% 
  lmer(eligible_population_enrolled ~ total_days + year_sp_2016 + opo + (1 | county), data = .) 

sp_16_model %>% 
  broom::tidy() %>% 
  filter(term %in% c("total_days", "year_sp_2016")) %>% 
  mutate(estimate_year = estimate * 365, 
         se_year = std.error * 365, 
         ci_low = estimate_year - 1.96*se_year, 
         ci_upper = estimate_year + 1.96*se_year) %>% 
  mutate(term = ifelse(term == "total_days", "Time (year)", term), 
         term = ifelse(term == "year_sp_2016", "2016 spline", term)) %>% 
  select(term, estimate_year, se_year, ci_low, ci_upper) %>% 
  rename("Term" = term, 
         "Coefficient" = estimate_year, 
         "SE" = se_year, 
         "Lower bound" = ci_low, 
         "Upper bound" = ci_upper) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling(full_width = F, bootstrap_options = c("hover", "striped"))

add_predictions(organ_sp, sp_16_model) %>% 
  ggplot(aes(x = total_days, y = pred, color = opo, type = county)) + 
  geom_line() + 
  viridis::scale_color_viridis(discrete = TRUE) + 
  labs(title = "Proportion of eligible New Yorkers enrolled as organ donors", 
       subtitle = "Modeling 2016 spline", 
       x = "Time as total days", 
       y = "Eligible population enrolled (%)") +
  geom_vline(xintercept = 2799, linetype = "dashed") +
  annotate(geom = "text", x = 2600, y = 5, label = "2016") +
  theme(legend.position = "bottom", 
        legend.title = element_blank()) + 
  guides(color = guide_legend(ncol = 2))
```

Similarily to the 2016 spline, modeling the 2017 policy we found main effects of time and the 2017 spline. On average, every year increase corresponded with a 2.56 percentage point increase in proportion of eligible individuals enrolled. However, after the 2017 spline, the rate of change in enrollment increased by 1.7 percentage points (95% CI: 1.55, 1.85) to 4.26 percentage points. 

```{r spline 2017, message = FALSE}
sp_17_model <- organ_sp %>% 
  lmer(eligible_population_enrolled ~ total_days + year_sp_2017 + opo + (1 | county), data = ., 
       REML = FALSE)

sp_17_model %>% 
  broom::tidy() %>% 
  filter(term %in% c("total_days", "year_sp_2017")) %>% 
  mutate(estimate_year = estimate * 365, 
         se_year = std.error * 365, 
         ci_low = estimate_year - 1.96*se_year, 
         ci_upper = estimate_year + 1.96*se_year) %>% 
  mutate(term = ifelse(term == "total_days", "Time (year)", term), 
         term = ifelse(term == "year_sp_2017", "2017 spline", term)) %>% 
  select(term, estimate_year, se_year, ci_low, ci_upper) %>% 
  rename("Term" = term, 
         "Coefficient" = estimate_year, 
         "SE" = se_year, 
         "Lower bound" = ci_low, 
         "Upper bound" = ci_upper) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling(full_width = F, bootstrap_options = c("hover", "striped"))

add_predictions(organ_sp, sp_17_model) %>% 
  ggplot(aes(x = total_days, y = pred, color = opo, type = county)) + 
  geom_line() +
  viridis::scale_color_viridis(discrete = TRUE) + 
  labs(title = "Proportion of eligible New Yorkers enrolled as organ donors", 
       subtitle = "Modeling 2017 spline", 
       x = "Time as total days", 
       y = "Eligible population enrolled (%)") + 
  geom_vline(xintercept = 3088, linetype = "dashed") + 
  annotate(geom = "text", x = 3300, y = 9, label = "2017") +
  theme(legend.position = "bottom", 
        legend.title = element_blank()) + 
  guides(color = guide_legend(ncol = 2))
```

The final model analyzed accounted for all three separate policy changes. Main effects were found for all three splines. This model found that after the 2012 policy was enacted, the estimated rate of increase in population enrollement decreased by .98 percentage points (95% CI: -1.06, -0.90). However, after the 2016 policy went into effect the rate of enrollment increased again by 0.33 percentage points (95% CI: 0.039, 0.627). Lastly, after the 2017 policy went into effect the rate of enrollment incresaed again by 2.47 percentage points (95% CI: 2.05, 2.88). Ultimately, after all three policies came into effect the estimated increase in organ donor enrollment is 4.9 percentage points per year (an estimated net effect of 1.82 percentage points). 

```{r all splines, message = FALSE}
all_sp_model <- organ_sp %>% 
  lmer(eligible_population_enrolled ~ total_days + year_sp_2012 + year_sp_2016 + year_sp_2017 + opo + 
         (1 | county), data = ., REML = FALSE)

all_sp_model %>% 
  broom::tidy() %>% 
  filter(term %in% c("total_days", "year_sp_2012", "year_sp_2016", "year_sp_2017")) %>% 
  mutate(estimate_year = estimate * 365, 
         se_year = std.error * 365, 
         ci_low = estimate_year - 1.96*se_year, 
         ci_upper = estimate_year + 1.96*se_year) %>% 
  mutate(term = ifelse(term == "total_days", "Time (year)", term), 
         term = ifelse(term == "year_sp_2012", "2012 spline", term), 
         term = ifelse(term == "year_sp_2016", "2016 spline", term), 
         term = ifelse(term == "year_sp_2017", "2017 spline", term)) %>% 
  select(term, estimate_year, se_year, ci_low, ci_upper) %>% 
  rename("Term" = term, 
         "Coefficient" = estimate_year, 
         "SE" = se_year, 
         "Lower bound" = ci_low, 
         "Upper bound" = ci_upper) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling(full_width = F, bootstrap_options = c("hover", "striped")) %>% 
  footnote(general = "Splines correspond with dates in which 3 major policy changes were inacted. \nEstimates are adjusted for organ donor organization")

add_predictions(organ_sp, all_sp_model) %>% 
  ggplot(aes(x = total_days, y = pred, color = opo, type = county)) + 
  geom_line() +
  viridis::scale_color_viridis(discrete = TRUE) + 
  geom_vline(xintercept = 1491, linetype = "dashed") + 
  geom_vline(xintercept = 2799, linetype = "dashed") + 
  geom_vline(xintercept = 3088, linetype = "dashed") + 
  annotate(geom = "text", x = 1720, y = 5, label = "2012") +
  annotate(geom = "text", x = 2600, y = 5, label = "2016") +
  annotate(geom = "text", x = 3300, y = 9, label = "2017") +
  theme(legend.position = "bottom", 
        legend.title = element_blank()) + 
  guides(color = guide_legend(ncol = 2)) + 
  labs(title = "Proportion of eligible New Yorkers enrolled as organ donors", 
       subtitle = "Modeling all splines", 
       x = "Time as total days", 
       y = "Eligible population enrolled (%)")
```

> NEED TO ADD INFO AND TABLE FOR LRT COMPARING NESTED MODELS

## Discussion

Using mixed-effects models we did find main effects of all three policies that were targeted at increasing organ donor enrollment. However, it is important to note that we cannot firmly draw any causal conclusions from the present analysis. While increases organ donor enrollment did coincide with major policy changes in New York, we did not compare the trends of enrollment in New York with those of the greater United States or another state that did not enact any policy during the same timeframe and thus did not establish a counter-factual. As such, we cannot rule out that the results we observed simply reflect a general trend in the United States and not any policy taken by the state of New York. That being said, our models do show a effects of policy changes. 

While the policies were designed to increase enrollment, it appears the 2012 policy might have had an opposite effect. The 2012 policy mandated that when residents of New York obtained a new driver's license...








